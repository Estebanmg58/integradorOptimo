# ?? Estructura Completa del Proyecto

```
IntegradorOptimo/
?
??? ?? README.md                          # Documentación completa del proyecto
??? ?? QUICKSTART.md                      # Guía de inicio rápido
??? ?? .gitignore                         # Exclusiones de Git
??? ?? Install-Service.ps1                # Script de instalación del servicio
??? ?? Integrador.sln                     # Solución de Visual Studio
?
??? ?? src/
?   ?
?   ??? ?? Integrador.Core/               # ? Proyecto de DTOs y Models
?   ?   ??? ?? Integrador.Core.csproj
?   ?   ?
?   ?   ??? ?? DTOs/
?   ?   ?   ??? ?? AsociadoDto.cs         # DTO de Asociados
?   ?   ?   ??? ?? ProductoDto.cs         # DTO de Productos
?   ?   ?   ??? ?? MovimientoDto.cs       # DTO de Movimientos
?   ?   ?   ??? ?? TasaDto.cs             # DTO de Tasas
?   ?   ?   ??? ?? FechaCorteDto.cs       # DTO de Fecha Corte
?   ?   ?
?   ?   ??? ?? Models/
?   ?       ??? ?? IntegrationSettings.cs # Modelo de configuración
?   ?
?   ??? ?? Integrador.Infrastructure/     # ? Proyecto de Repositorios
?   ?   ??? ?? Integrador.Infrastructure.csproj
?   ?   ?
?   ?   ??? ?? Repositories/
?   ?       ??? ?? IIntegrationSettingsRepository.cs
?   ?       ??? ?? IntegrationSettingsRepository.cs
?   ?       ??? ?? IErpRepository.cs
?   ?       ??? ?? ErpRepository.cs
?   ?
?   ??? ?? Integrador.Worker/             # ? Proyecto Worker Service
?       ??? ?? Integrador.Worker.csproj
?       ??? ?? Program.cs                 # Configuración del Host
?       ??? ?? IntegrationWorker.cs       # BackgroundService principal
?       ??? ?? appsettings.json           # Configuración de producción
?       ??? ?? appsettings.Development.json # Configuración de desarrollo
?       ?
?       ??? ?? Services/
?           ??? ?? IApiClientService.cs   # Interfaz del cliente HTTP
?           ??? ?? ApiClientService.cs    # Implementación del cliente HTTP
?           ??? ?? PollyPolicies.cs       # Políticas de resiliencia
?
??? ?? scripts/                           # ? Scripts SQL
?   ??? ?? CreateIntegrationSettings.sql  # Crear tabla de configuración
?   ??? ?? ERP_SPConsultaDta_Example.sql  # Ejemplo del SP del ERP
?
??? ?? logs/                              # Logs locales (solo desarrollo)
    ??? ?? log-YYYY-MM-DD.txt

```

## ?? Resumen de Archivos

### ?? Archivos Principales

| Archivo | Propósito | Estado |
|---------|-----------|--------|
| `IntegrationWorker.cs` | BackgroundService que ejecuta la sincronización | ? |
| `Program.cs` | Configuración de DI, Serilog, Polly, Windows Service | ? |
| `ApiClientService.cs` | Cliente HTTP para enviar datos a la API | ? |
| `ErpRepository.cs` | Lee datos del ERP usando Dapper | ? |
| `IntegrationSettingsRepository.cs` | Lee configuración de la BD | ? |

### ?? DTOs (Data Transfer Objects)

| DTO | Campos | Volumen |
|-----|--------|---------|
| `AsociadoDto` | NumeroDocumento, Nombres, Apellidos, Email, Celular, FechaAfiliacion, Estado | ~9,000 |
| `ProductoDto` | NumeroDocumento, CodigoProducto, NombreProducto, Saldo, FechaApertura, Estado | ~14,000 |
| `MovimientoDto` | NumeroDocumento, CodigoProducto, FechaMovimiento, TipoMovimiento, Valor, Descripcion | ~50K-100K |
| `TasaDto` | CodigoTasa, NombreTasa, ValorTasa, FechaVigencia | ~100 |
| `FechaCorteDto` | FechaCorte | 1 |

### ?? Configuración

| Archivo | Entorno | Descripción |
|---------|---------|-------------|
| `appsettings.json` | Producción | Configuración para el servicio de Windows |
| `appsettings.Development.json` | Desarrollo | Configuración para pruebas locales |
| `IntegrationSettings` (BD) | Runtime | Configuración dinámica (cron, batch size, enables) |

### ?? Paquetes NuGet

| Proyecto | Paquetes |
|----------|----------|
| **Integrador.Core** | (ninguno - solo DTOs) |
| **Integrador.Infrastructure** | Dapper 2.1.35, Microsoft.Data.SqlClient 5.1.5 |
| **Integrador.Worker** | Serilog.Extensions.Hosting 8.0.0, Serilog.Settings.Configuration 8.0.0, Serilog.Sinks.File 5.0.0, Serilog.Sinks.Console 5.0.1, Polly 8.2.0, Microsoft.Extensions.Http.Polly 8.0.0, NCrontab 3.3.3, Microsoft.Extensions.Hosting.WindowsServices 8.0.0 |

### ??? Scripts SQL

1. **CreateIntegrationSettings.sql**
   - Crea tabla `IntegrationSettings`
   - Inserta configuración inicial
   - Crea SP `sp_UpdateIntegrationSetting`

2. **ERP_SPConsultaDta_Example.sql**
   - Ejemplo del SP que debe existir en el ERP
   - Incluye las 5 consultas necesarias
   - Con casos de prueba

### ?? Scripts de Instalación

**Install-Service.ps1** - Comandos disponibles:
```powershell
.\Install-Service.ps1 -Action install    # Instalar servicio
.\Install-Service.ps1 -Action uninstall  # Desinstalar servicio
.\Install-Service.ps1 -Action status     # Ver estado
.\Install-Service.ps1 -Action start      # Iniciar
.\Install-Service.ps1 -Action stop       # Detener
.\Install-Service.ps1 -Action restart    # Reiniciar
.\Install-Service.ps1 -Action logs       # Ver logs en tiempo real
```

## ?? Flujo de Ejecución

```
???????????????????????????????????????????????????????????????
?                    INTEGRADOR ÓPTIMO                        ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?  1. Worker inicia (Windows Service)                        ?
?     - Lee configuración de IntegrationSettings             ?
?     - Parsea Cron Expression con NCrontab                  ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?  2. Espera hasta próxima ejecución programada               ?
?     - Ejemplo: "0 2 * * *" = 2:00 AM diariamente           ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?  3. Ejecuta RunIntegrationAsync()                           ?
?     ??? SyncAsociadosAsync()      [si EnableAsociados]     ?
?     ??? SyncProductosAsync()      [si EnableProductos]     ?
?     ??? SyncMovimientosAsync()    [si EnableMovimientos]   ?
?     ??? SyncTasasAsync()          [si EnableTasas]         ?
?     ??? SyncFechaCorteAsync()     [si EnableFechaCorte]    ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?  4. Para cada entidad habilitada:                           ?
?     ??? ErpRepository.GetXxxAsync()                        ?
?     ?   ??? EXEC ERP_SPConsultaDta @TipoConsulta=X         ?
?     ??? Particiona en lotes de BatchSize (ej: 500)        ?
?     ??? Por cada lote:                                      ?
?         ??? ApiClientService.SendXxxAsync()                ?
?         ?   ??? POST a https://api.fodnosuma.com/...       ?
?         ??? Log: "? Batch X/Y: Z registros en Nms"       ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?  5. Políticas de Resiliencia (Polly)                       ?
?     ??? Retry: 3 intentos con backoff exponencial          ?
?     ??? Circuit Breaker: 5 fallos ? 30s abierto           ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?  6. Logging (Serilog)                                       ?
?     ??? Archivo: C:\Logs\IntegradorOptimo\log-*.txt       ?
?     ??? Consola: Para debug en desarrollo                  ?
?     ??? Rotación: Diaria, 30 días de retención            ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?  7. Vuelve al paso 2 (espera próxima ejecución)            ?
???????????????????????????????????????????????????????????????
```

## ? Checklist de Implementación

### Antes de Instalar en Producción

- [ ] **Base de Datos Destino**
  - [ ] Ejecutar `scripts/CreateIntegrationSettings.sql`
  - [ ] Verificar tabla `IntegrationSettings` creada
  - [ ] Configurar valores de Cron, BatchSize, etc.

- [ ] **Base de Datos ERP**
  - [ ] Verificar que existe `ERP_SPConsultaDta`
  - [ ] Probar SP con `@TipoConsulta = 1, 2, 3, 4, 5`
  - [ ] Verificar tiempos de respuesta aceptables

- [ ] **Configuración de Aplicación**
  - [ ] Editar `appsettings.json` con connection strings reales
  - [ ] Configurar BaseUrl de la API
  - [ ] Obtener y configurar JWT Token válido

- [ ] **Pruebas Locales**
  - [ ] Ejecutar `dotnet run` en modo desarrollo
  - [ ] Verificar que conecta a bases de datos
  - [ ] Verificar que conecta a la API
  - [ ] Revisar logs generados

- [ ] **Instalación como Servicio**
  - [ ] Compilar en Release: `dotnet build -c Release`
  - [ ] Ejecutar `.\Install-Service.ps1 -Action install` como Admin
  - [ ] Verificar que el servicio está Running
  - [ ] Revisar logs en `C:\Logs\IntegradorOptimo\`

- [ ] **Monitoreo Post-Instalación**
  - [ ] Verificar primera ejecución programada
  - [ ] Revisar logs de sincronización completa
  - [ ] Verificar datos llegaron a la API
  - [ ] Configurar alertas (opcional)

## ?? ¡Proyecto Completado!

Todo el código está listo y compilando correctamente. El proyecto incluye:

? Arquitectura de 3 capas (Core, Infrastructure, Worker)  
? Background Service con ejecución programada (NCrontab)  
? Procesamiento por lotes configurable  
? Reintentos resilientes (Polly)  
? Logging profesional (Serilog)  
? Windows Service listo para producción  
? Scripts de instalación automatizados  
? Documentación completa  

**¡Todo melo caramelo! ??**
